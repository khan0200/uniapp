<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student List - UniApp</title>
    <link href="./dist/output.css" rel="stylesheet">
    <link href="./dark-mode-styles.css" rel="stylesheet">
    <link href="./sizing-fixes.css" rel="stylesheet">
    <script src="./dark-mode.js"></script>
    <script src="./auth.js"></script>
    <script src="./audit-logger.js"></script>
    <style>
        .table-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #f2f2f7;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-header {
            background-color: #f9f9fb;
            border-bottom: 1px solid #f2f2f7;
        }

        .table-header th {
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-body tr {
            border-bottom: 1px solid #f2f2f7;
            transition: all 0.2s ease;
            background-color: #ffffff;
        }

        .table-body tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table-body tr:last-child {
            border-bottom: none;
        }

        .table-body tr:hover {
            background-color: #e3f2fd !important;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode table rows */
        .dark .table-body tr {
            background-color: #1e293b !important;
        }

        .dark .table-body tr:nth-child(even) {
            background-color: #334155 !important;
        }

        .dark .table-body tr:hover {
            background-color: #1e40af !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .table-body td {
            padding: 8px 8px;
            font-size: 14px;
            color: #1d1d1f;
            white-space: nowrap;
        }

        .student-id {
            font-weight: 600;
            color: #007aff;
            width: 60px;
            max-width: 60px;
            font-size: 13px;
        }

        .fullname {
            color: #1d1d1f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 250px;
            max-width: 400px;
            width: 35%;
            font-weight: 500;
        }

        .phone-col {
            color: #86868b;
            font-size: 14px;
            width: 120px;
            max-width: 120px;
        }

        .tariff-col {
            color: #86868b;
            font-size: 14px;
            width: 100px;
            max-width: 100px;
        }

        .education-col {
            color: #86868b;
            font-size: 14px;
            width: 120px;
            max-width: 120px;
        }

        .passport-col {
            color: #86868b;
            font-size: 14px;
            width: 120px;
            max-width: 120px;
        }

        .action-col {
            width: 60px;
            max-width: 60px;
            text-align: center;
        }

        .action-btn {
            padding: 6px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-btn {
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
        }

        .view-btn:hover {
            background: rgba(0, 122, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Inline Edit Styles */
        .info-value {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .edit-icon {
            opacity: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #ff9500;
            flex-shrink: 0;
        }

        .info-value:hover .edit-icon {
            opacity: 1;
            background: rgba(255, 149, 0, 0.1);
        }

        .edit-icon:hover {
            background: rgba(255, 149, 0, 0.2) !important;
            transform: scale(1.1);
        }

        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #007aff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            color: #1d1d1f;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .dark .edit-input {
            background: #0f172a !important;
            border: 2px solid #3b82f6 !important;
            color: #f1f5f9 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        }

        .edit-textarea {
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }

        .edit-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #007aff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            color: #1d1d1f;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .dark .edit-select {
            background: #0f172a !important;
            border: 2px solid #3b82f6 !important;
            color: #f1f5f9 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        }

        .edit-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .edit-btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .save-btn {
            background: #34c759;
            color: white;
        }

        .save-btn:hover {
            background: #30d158;
            transform: translateY(-1px);
        }

        .save-btn:disabled {
            background: #86868b;
            cursor: not-allowed;
            transform: none;
        }

        .cancel-btn {
            background: #ff3b30;
            color: white;
        }

        .cancel-btn:hover {
            background: #ff453a;
            transform: translateY(-1px);
        }

        .field-editing {
            background: rgba(0, 122, 255, 0.05) !important;
            border-color: rgba(0, 122, 255, 0.3) !important;
        }

        /* Modern Loading Spinner from payments.html */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #f2f2f7;
            border-top: 2px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 60px 20px;
            color: #ff3b30;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .retry-button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .retry-button:hover {
            background-color: #0056cc;
        }

        /* Modern Modal styles from payments.html */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .dark .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8) !important;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .dark .modal-content {
            background-color: #1e293b !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5) !important;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 16px 24px 14px;
            border-bottom: 1px solid #f2f2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #007aff 0%, #0056cc 100%);
            color: white;
        }

        .dark .modal-header {
            border-bottom: 1px solid #475569 !important;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .dark .modal-body {
            background-color: #1e293b !important;
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e8f2ff;
        }

        .dark .info-section {
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
            border: 1px solid #64748b !important;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark .section-title {
            color: #f1f5f9 !important;
        }

        .info-item {
            margin-bottom: 12px;
        }

        .info-label {
            font-size: 12px;
            color: #86868b;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark .info-label {
            color: #94a3b8 !important;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .dark .info-value {
            color: #f1f5f9 !important;
            background: rgba(15, 23, 42, 0.8) !important;
            border: 1px solid #475569 !important;
        }

        .info-value:hover {
            background: rgba(0, 122, 255, 0.1);
            border-color: rgba(0, 122, 255, 0.2);
            transform: translateY(-1px);
        }

        .dark .info-value:hover {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.4) !important;
        }

        .info-value.highlight {
            background: #007aff;
            color: white;
            font-weight: 600;
        }

        .dark .info-value.highlight {
            background: #3b82f6 !important;
        }

        /* Copy animation styles */
        .info-value.copying {
            background: #34c759 !important;
            color: white !important;
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3) !important;
            border-color: #34c759 !important;
        }

        .dark .info-value.copying {
            background: #10b981 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
            border-color: #10b981 !important;
        }

        .info-value.copy-success {
            animation: copyPulse 0.6s ease-out;
        }

        @keyframes copyPulse {
            0% {
                transform: scale(1);
                background: #34c759;
                color: white;
            }
            50% {
                transform: scale(1.08);
                background: #30d158;
                box-shadow: 0 6px 20px rgba(52, 199, 89, 0.4);
            }
            100% {
                transform: scale(1);
            }
        }

        .dark .info-value.copy-success {
            animation: copyPulseDark 0.6s ease-out;
        }

        @keyframes copyPulseDark {
            0% {
                transform: scale(1);
                background: #10b981;
                color: white;
            }
            50% {
                transform: scale(1.08);
                background: #059669;
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Copy indicator */
        .copy-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #34c759;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .dark .copy-indicator {
            background: #10b981 !important;
        }

        .copy-indicator.show {
            opacity: 1;
            top: -35px;
        }

        .copy-indicator::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #34c759;
        }

        .dark .copy-indicator::after {
            border-top-color: #10b981 !important;
        }

        .info-value {
            position: relative;
        }

        /* Modern Sidebar Styles */
        .modern-sidebar {
            width: 70px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modern-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 18px;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .sidebar-logo:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .sidebar-nav {
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 46px;
            height: 46px;
            margin: 0 auto 12px;
            border-radius: 14px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-item:hover::before {
            opacity: 1;
        }

        .nav-item:hover {
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-item.active::before {
            opacity: 0;
        }

        .nav-item.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            transition: all 0.3s ease;
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1);
        }

        /* Tooltip styles - Clean and Simple */
        .modern-sidebar {
            z-index: 1000;
            overflow: visible;
        }

        .modern-sidebar .nav-item {
            position: relative;
            overflow: visible;
        }

        .modern-sidebar .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%) translateX(-8px) scale(0.8);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999999;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modern-sidebar .nav-item:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0) scale(1);
        }

        /* Ensure main content doesn't overlap tooltips */
        .flex {
            overflow: visible;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modern-sidebar {
                width: 60px;
            }
            
            .sidebar-logo {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .nav-item {
                width: 42px;
                height: 42px;
            }
            
            .nav-icon {
                width: 20px;
                height: 20px;
            }

            .edit-form-grid {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <div class="flex h-screen">
        <!-- Modern Sidebar -->
        <div class="modern-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">UA</div>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item" data-tooltip="Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                </a>
                <a href="register.html" class="nav-item" data-tooltip="Register Student">
                    <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                </a>
                <a href="studentlist.html" class="nav-item active" data-tooltip="Student List">
                    <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                    </svg>
                </a>
                <a href="payments.html" class="nav-item" data-tooltip="Payments">
                    <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                        <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" />
                    </svg>
                </a>
                <a href="appfee.html" class="nav-item" data-tooltip="Application Fee">
                    <svg xmlns="http://www.w3.org/2000/svg" class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <div class="p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-8 transition-colors duration-300">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100 transition-colors duration-300">Registered Students</h1>
                            <a href="register.html" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors duration-200">
                                Add New Student
                            </a>
                        </div>

                        <!-- Search and Filter -->
                        <div class="mb-6 flex gap-4">
                            <div class="flex-1">
                                <input type="text" id="searchInput" placeholder="Search by ID, name, phone, tariff, or passport..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-colors duration-200">
                            </div>
                            <select id="educationFilter" class="px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-colors duration-200">
                                <option value="">All Education Levels</option>
                            </select>
                            <select id="tariffFilter" class="px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-colors duration-200">
                                <option value="">All Tariffs</option>
                            </select>
                        </div>

                        <!-- Student List -->
                        <div class="table-container">
                            <table class="table">
                                <thead class="table-header">
                                    <tr>
                                        <th>ID</th>
                                        <th>Full Name</th>
                                        <th>Phone</th>
                                        <th>Tariff</th>
                                        <th>Education Level</th>
                                        <th>Passport Number</th>
                                        <th>See</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody" class="table-body">
                                                        <!-- Loading state -->
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading student data...</p>
                        </td>
                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="mt-6 flex items-center justify-between">
                            <div class="text-sm text-gray-500">
                                Showing <span id="startCount">0</span> to <span id="endCount">0</span> of <span id="totalCount">0</span> students
                            </div>
                            <div class="flex gap-2">
                                <button id="prevPage" class="px-4 py-2 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors duration-200">Previous</button>
                                <button id="nextPage" class="px-4 py-2 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors duration-200">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <div class="student-avatar" id="studentAvatar"></div>
                        <div>
                        <div id="modalStudentName">Student Details</div>
                        <div style="font-size: 14px; font-weight: 400; opacity: 0.9;" id="modalStudentId"></div>
                    </div>
                </h2>
                <button class="close-button" onclick="closeStudentModal()">&times;</button>
                        </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>



    <!-- Enhanced Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-xl shadow-xl flex items-center space-x-3 transform translate-x-full opacity-0 transition-all duration-300 ease-in-out z-50 border-l-4 border-white">
        <div class="flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="flex-1">
            <span class="text-sm font-semibold">Copied to clipboard</span>
        </div>
        <button onclick="hideToast()" class="flex-shrink-0 ml-2 text-white hover:text-gray-200 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>



    <!-- Working Data Loader -->
    <script>
        // Global variables for pagination and data management
        let allStudents = [];
        let filteredStudents = [];
        let currentPage = 1;
        const itemsPerPage = 30;
        let db = null;

        // University options from register.html - moved to global scope
        const universityOptions = {
            COLLEGE: ["SeoJeong", "Daewon", "Kunjang", "DIST", "SeoYeong", "Chungbuk", "Jangan", "Other"],
            MASTERS: [
                "Kangwon - E VISA", "SunMoon - E VISA", "Joon Bu - E VISA", "AnYang - E VISA",
                "SMIT - E VISA", "Woosuk - E VISA", "Dong eui E VISA", "Sejong", "Gachon", "BUFS",
                "Won Kwan - E VISA (Sertifikatsiz)", "Youngsan - E VISA (Sertifikatsiz)"
            ],
            BACHELOR: [
                "Busan University of Foreign Studies (BUFS)", "Chonnam National University", "Chung-Ang University", "Chungnam National University", 
                "DGIST", "Daegu University", "Daejin University", "Dong-A University", 
                "Dong-Eui University", "Ewha Womans University", "Far East University", "Gachon University", "Hankuk University of Foreign Studies", 
                "Hanyang University", "Incheon National University", "Inha University", "Jeonbuk National University", 
                "Kangwon National University", "Keimyung University", "Konkuk University", "Korea Advanced Institute of Science and Technology (KAIST)", 
                "Korea University", "Kookmin University", "Kyung Hee University", "Kyungpook National University", 
                "Pohang University of Science and Technology (POSTECH)", "Sejong University", "Seoul National University (SNU)", 
                "Semyung University", "Sogang University", "SunMoon University", "Sungkyunkwan University (SKKU)", "Sungshin Women's University", 
                "TongMyong University", "Ulsan National Institute of Science and Technology (UNIST)", "University of Seoul", "Yeungnam University", 
                "Yonsei University", "Other"
            ]
        };

        async function loadDataDirectly() {
            console.log('🔄 Loading student data...');
            const tbody = document.getElementById('studentTableBody');
            
            try {
                // Show loading state in table
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading student data...</p>
                        </td>
                    </tr>
                `;
                
                // Import Firebase
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js');
                const { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
                
                // Firebase config
                const firebaseConfig = {
                    apiKey: "AIzaSyDtc3StzPcG7oivivYlXnKrR6S0c0xelJg",
                    authDomain: "uniuni-dd4af.firebaseapp.com",
                    projectId: "uniuni-dd4af",
                    storageBucket: "uniuni-dd4af.firebasestorage.app",
                    messagingSenderId: "583982319464",
                    appId: "1:583982319464:web:ed3021724ef42f196df8dd"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Initialize audit logger
                if (window.auditLogger) {
                    await window.auditLogger.initialize(db);
                    window.auditLogger.setCurrentUser('admin'); // Set current user
                    console.log('✅ Audit Logger initialized in studentlist.html');
                }
                
                // Fetch students
                const studentsRef = collection(db, "register");
                const q = query(studentsRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                console.log(`✅ Found ${querySnapshot.size} students`);
                
                // Store all students data
                allStudents = [];
                querySnapshot.forEach((docSnap) => {
                    const student = docSnap.data();
                    allStudents.push({
                        id: docSnap.id,
                        ...student
                    });
                });
                
                // Initialize filtered students
                filteredStudents = [...allStudents];
                
                // Reset to first page
                currentPage = 1;
                
                // Update table with pagination
                updateTable();
                
                console.log('✅ Data loaded successfully!');
                
                // Set up modal functionality
                setupModalFunctionality(db);
                
                // Setup search functionality
                setupSearch();
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                displayError(`Error loading data: ${error.message}`);
            }
        }

        // Update table with current data and pagination
        function updateTable() {
            const tbody = document.getElementById('studentTableBody');
            
            if (filteredStudents.length === 0) {
                displayNoResults();
                updatePagination();
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentStudents = filteredStudents.slice(startIndex, endIndex);
            
            // Generate table HTML
            const tableHTML = currentStudents.map(student => `
                <tr>
                    <td class="student-id">${student.studentId || ''}</td>
                    <td class="fullname" title="${student.fullname || ''}">${student.fullname || ''}</td>
                    <td class="phone-col">${student.phone1 || ''}</td>
                    <td class="tariff-col">${student.tariff || ''}</td>
                    <td class="education-col">${student.educationLevel || ''}</td>
                    <td class="passport-col">${student.passportNumber || ''}</td>
                    <td class="action-col">
                        <button onclick="showStudentDetails('${student.id}')" class="action-btn view-btn" title="View Details">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = tableHTML;
            
            // Update pagination info
            updatePagination();
        }

        // Function to update pagination information
        function updatePagination() {
            const totalStudents = filteredStudents.length;
            const startCount = totalStudents === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endCount = Math.min(currentPage * itemsPerPage, totalStudents);
            const totalPages = Math.ceil(totalStudents / itemsPerPage);
            
            document.getElementById('startCount').textContent = startCount;
            document.getElementById('endCount').textContent = endCount;
            document.getElementById('totalCount').textContent = totalStudents;
            
            // Update button states - same logic as payments.html
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages || totalStudents <= itemsPerPage;
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const educationFilter = document.getElementById('educationFilter');
            const tariffFilter = document.getElementById('tariffFilter');
            
            // Populate education filter options
            const educationLevels = [...new Set(allStudents.map(s => s.educationLevel).filter(Boolean))];
            educationFilter.innerHTML = '<option value="">All Education Levels</option>' + 
                educationLevels.map(level => `<option value="${level}">${level}</option>`).join('');
            
            // Populate tariff filter options
            const tariffs = [...new Set(allStudents.map(s => s.tariff).filter(Boolean))];
            tariffFilter.innerHTML = '<option value="">All Tariffs</option>' + 
                tariffs.map(tariff => `<option value="${tariff}">${tariff}</option>`).join('');
            
            // Event listeners
            searchInput.addEventListener('input', performSearch);
            educationFilter.addEventListener('change', performSearch);
            tariffFilter.addEventListener('change', performSearch);
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const educationLevel = document.getElementById('educationFilter').value;
            const tariff = document.getElementById('tariffFilter').value;
            
            filteredStudents = allStudents.filter(student => {
                const matchesSearch = !searchTerm || 
                    (student.studentId && student.studentId.toLowerCase().includes(searchTerm)) ||
                    (student.fullname && student.fullname.toLowerCase().includes(searchTerm)) ||
                    (student.phone1 && student.phone1.toLowerCase().includes(searchTerm)) ||
                    (student.tariff && student.tariff.toLowerCase().includes(searchTerm)) ||
                    (student.passportNumber && student.passportNumber.toLowerCase().includes(searchTerm));
                
                const matchesEducation = !educationLevel || student.educationLevel === educationLevel;
                const matchesTariff = !tariff || student.tariff === tariff;
                
                return matchesSearch && matchesEducation && matchesTariff;
            });
            
            // Reset to first page when searching
            currentPage = 1;
            updateTable();
        }

        // Display error state
        function displayError(message) {
            const tbody = document.getElementById('studentTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="error">
                            <div class="error-icon">⚠️</div>
                            <p>${message}</p>
                        </td>
                    </tr>
                `;
            
            // Update pagination info for error state
            document.getElementById('startCount').textContent = '0';
            document.getElementById('endCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('prevPage').disabled = true;
            document.getElementById('nextPage').disabled = true;
        }

        // Display no results state
        function displayNoResults() {
            const tbody = document.getElementById('studentTableBody');
            const searchTerm = document.getElementById('searchInput').value.trim();
            const educationLevel = document.getElementById('educationFilter').value;
            const tariff = document.getElementById('tariffFilter').value;
            
            let message = 'No students found';
            if (searchTerm || educationLevel || tariff) {
                message += ' matching your search criteria';
            }
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <p>${message}</p>

                    </td>
                </tr>
            `;
            
            // Update pagination info for no results
            document.getElementById('startCount').textContent = '0';
            document.getElementById('endCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('prevPage').disabled = true;
            document.getElementById('nextPage').disabled = true;
        }

        // Clear search function
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('educationFilter').value = '';
            document.getElementById('tariffFilter').value = '';
            performSearch();
        }

        // Pagination event listeners
        function setupPagination() {
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                }
            });
        }

        // Modal functionality
        function setupModalFunctionality(db) {
            const modal = document.getElementById('studentModal');

            // Show student details function
            window.showStudentDetails = async function(studentId) {
                console.log("Showing details for student:", studentId);
                
                try {
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
                    const studentRef = doc(db, "register", studentId);
                    const studentDoc = await getDoc(studentRef);
                    
                    if (studentDoc.exists()) {
                        const studentData = studentDoc.data();
                        
                        // Update modal content
                        updateModalContent(studentData);
                        
                        // Show modal with animation
                        modal.classList.add('active');
                    } else {
                        alert("Student data not found.");
                    }
                } catch (error) {
                    console.error("Error fetching student details:", error);
                    alert("Error loading student details.");
                }
            };

            // Close modal function
            window.closeStudentModal = function() {
                modal.classList.remove('active');
            };

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeStudentModal();
                }
            });

            // Update modal content with inline edit functionality
            function updateModalContent(studentData) {
                // Update header
                const studentName = studentData.fullname || 'Unknown Student';
                const studentId = studentData.studentId || 'N/A';
                
                document.getElementById('modalStudentName').textContent = studentName;
                document.getElementById('modalStudentId').textContent = `ID: ${studentId}`;
                
                // Create avatar with initials
                const avatar = document.getElementById('studentAvatar');
                const initials = studentName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                avatar.textContent = initials;
                
                // Store current student data globally for editing
                window.currentStudentData = studentData;
                
                // Create modern modal body content with inline edit
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="student-info-grid">
                        <!-- Personal Information -->
                        <div class="info-section">
                            <div class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                </svg>
                                Personal Information
                            </div>
                            ${createReadOnlyField('Full Name', 'fullname', studentData.fullname)}
                            ${createEditableField('First Name', 'firstName', studentData.firstName, 'text')}
                            ${createEditableField('Last Name', 'lastName', studentData.lastName, 'text')}
                            ${createEditableField('Middle Name', 'middleName', studentData.middleName, 'text')}
                            ${createEditableField('Passport Number', 'passportNumber', studentData.passportNumber, 'text')}
                            ${createEditableField('Birth Date', 'birthDate', studentData.birthDate, 'date')}
                        </div>

                        <!-- Contact Information -->
                        <div class="info-section">
                            <div class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                </svg>
                                Contact Information
                            </div>
                            ${createEditableField('Email', 'email', studentData.email, 'email')}
                            ${createEditableField('Primary Phone', 'phone1', studentData.phone1, 'tel')}
                            ${createEditableField('Secondary Phone', 'phone2', studentData.phone2, 'tel')}
                            ${createEditableField('Address', 'address', studentData.address, 'textarea')}
                            ${createEditableField('How They Heard About Us', 'hearAboutUs', studentData.hearAboutUs, 'select', ['instagram', 'friend', 'topikcenter', 'seoul', 'umida', 'other'])}
                            <div class="info-item">
                                <div class="info-label">Registration Date</div>
                                <div class="info-value">${formatTimestamp(studentData.timestamp)}</div>
                            </div>
                        </div>

                        <!-- Education Information -->
                        <div class="info-section">
                            <div class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                                </svg>
                                Education Information
                            </div>
                            ${createEditableField('Education Level', 'educationLevel', studentData.educationLevel, 'select', ['COLLEGE', 'BACHELOR', 'MASTERS'])}
                            ${createEditableField('Language Certificate', 'languageCertificate', studentData.languageCertificate, 'select', ['ielts-expected', 'ielts-5.5', 'ielts-6.0', 'ielts-6.5', 'ielts-7.0', 'ielts-7.5', 'ielts-8.0', 'ielts-8.5', 'ielts-9.0', 'topik-2', 'topik-3', 'topik-4', 'topik-5', 'topik-6', 'topik-expected'])}
                            ${createUniversityField('First Choice University', 'university1', studentData.university1, studentData.educationLevel)}
                            ${createUniversityField('Second Choice University', 'university2', studentData.university2, studentData.educationLevel)}
                            ${createEditableField('Tariff Plan', 'tariff', studentData.tariff, 'select', ['STANDART', 'PREMIUM', 'VISA PLUS', '1FOIZ'])}
                            ${createEditableField('Additional Notes', 'additionalNotes', studentData.additionalNotes, 'textarea')}
                        </div>
                    </div>
                `;
            }

            // Create read-only field (no edit functionality)
            function createReadOnlyField(label, fieldName, value) {
                const displayValue = value || 'N/A';
                
                return `
                    <div class="info-item">
                        <div class="info-label">${label} <span style="font-size: 10px; color: #86868b;">(Auto-generated)</span></div>
                        <div class="info-value" data-field="${fieldName}" onclick="copyToClipboard(this)">
                            <span class="field-value">${displayValue}</span>
                            <svg class="edit-icon" style="opacity: 0.3; cursor: not-allowed;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                `;
            }



            // Create university field with dynamic options based on education level
            function createUniversityField(label, fieldName, value, educationLevel) {
                const displayValue = value || 'N/A';
                const actualValue = value || '';
                
                // Get university options based on education level
                const options = universityOptions[educationLevel] || [];
                
                const optionsHtml = options.map(opt => 
                    `<option value="${opt}" ${actualValue === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                
                const editElement = `<select class="edit-input edit-select" data-field="${fieldName}">
                    <option value="">Select University...</option>
                    ${optionsHtml}
                </select>`;

                return `
                    <div class="info-item">
                        <div class="info-label">${label}</div>
                        <div class="info-value" data-field="${fieldName}" onclick="copyToClipboard(this)">
                            <span class="field-value">${displayValue}</span>
                            <svg class="edit-icon" onclick="startEdit(event, '${fieldName}')" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </div>
                        <div class="edit-form" style="display: none;">
                            ${editElement}
                            <div class="edit-controls">
                                <button class="edit-btn-small save-btn" onclick="saveField('${fieldName}')">
                                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Save
                                </button>
                                <button class="edit-btn-small cancel-btn" onclick="cancelEdit('${fieldName}')">
                                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Create editable field with inline edit functionality
            function createEditableField(label, fieldName, value, type, options = []) {
                const displayValue = value || 'N/A';
                const actualValue = value || '';
                
                let editElement = '';
                if (type === 'textarea') {
                    editElement = `<textarea class="edit-input edit-textarea" data-field="${fieldName}">${actualValue}</textarea>`;
                } else if (type === 'select') {
                    const optionsHtml = options.map(opt => 
                        `<option value="${opt}" ${actualValue === opt ? 'selected' : ''}>${opt}</option>`
                    ).join('');
                    editElement = `<select class="edit-input edit-select" data-field="${fieldName}">
                        <option value="">Select...</option>
                        ${optionsHtml}
                    </select>`;
                } else {
                    editElement = `<input type="${type}" class="edit-input" data-field="${fieldName}" value="${actualValue}">`;
                }

                return `
                    <div class="info-item">
                        <div class="info-label">${label}</div>
                        <div class="info-value" data-field="${fieldName}" onclick="copyToClipboard(this)">
                            <span class="field-value">${displayValue}</span>
                            <svg class="edit-icon" onclick="startEdit(event, '${fieldName}')" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </div>
                        <div class="edit-form" style="display: none;">
                            ${editElement}
                            <div class="edit-controls">
                                <button class="edit-btn-small save-btn" onclick="saveField('${fieldName}')">
                                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Save
                                </button>
                                <button class="edit-btn-small cancel-btn" onclick="cancelEdit('${fieldName}')">
                                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Format timestamp for display
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'N/A';
                
                // Handle Firestore timestamp
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                
                return new Intl.DateTimeFormat('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                }).format(date);
            }
        }

        // Enhanced copy to clipboard function with animations
        window.copyToClipboard = function(element) {
            const text = element.textContent.trim();
            if (text && text !== 'N/A' && text !== '') {
                // Add copying state immediately
                element.classList.add('copying');
                
                // Create and show copy indicator
                const indicator = document.createElement('div');
                indicator.className = 'copy-indicator';
                indicator.textContent = 'Copying...';
                element.appendChild(indicator);
                
                // Show indicator
                setTimeout(() => {
                    indicator.classList.add('show');
                }, 10);
                
                navigator.clipboard.writeText(text).then(() => {
                    console.log('✅ Copied to clipboard:', text);
                    
                    // Update indicator
                    indicator.textContent = 'Copied!';
                    
                    // Remove copying state and add success animation
                    element.classList.remove('copying');
                    element.classList.add('copy-success');
                    
                    // Show toast notification
                    showToast(`✅ Copied: "${text.length > 30 ? text.substring(0, 30) + '...' : text}"`, 'bg-green-600');
                    
                    // Clean up after animation
                    setTimeout(() => {
                        element.classList.remove('copy-success');
                        if (indicator && indicator.parentNode) {
                            indicator.classList.remove('show');
                            setTimeout(() => {
                                if (indicator.parentNode) {
                                    indicator.parentNode.removeChild(indicator);
                                }
                            }, 300);
                        }
                    }, 600);
                    
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    
                    // Remove copying state and show error
                    element.classList.remove('copying');
                    indicator.textContent = 'Failed!';
                    indicator.style.background = '#ff3b30';
                    
                    showToast('❌ Failed to copy to clipboard', 'bg-red-600');
                    
                    // Clean up error state
                    setTimeout(() => {
                        if (indicator && indicator.parentNode) {
                            indicator.classList.remove('show');
                            setTimeout(() => {
                                if (indicator.parentNode) {
                                    indicator.parentNode.removeChild(indicator);
                                }
                            }, 300);
                        }
                    }, 1500);
                });
            } else {
                // Show warning animation for empty content
                element.style.background = '#ff9500';
                element.style.color = 'white';
                
                const indicator = document.createElement('div');
                indicator.className = 'copy-indicator';
                indicator.textContent = 'No content';
                indicator.style.background = '#ff9500';
                element.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.classList.add('show');
                }, 10);
                
                showToast('⚠️ No content to copy', 'bg-yellow-600');
                
                // Reset after warning
                setTimeout(() => {
                    element.style.background = '';
                    element.style.color = '';
                    if (indicator && indicator.parentNode) {
                        indicator.classList.remove('show');
                        setTimeout(() => {
                            if (indicator.parentNode) {
                                indicator.parentNode.removeChild(indicator);
                            }
                        }, 300);
                    }
                }, 1500);
            }
        };

        // Toast notification function
        window.showToast = function(message = '✅ Copied to clipboard', bgClass = 'bg-green-600') {
            const toast = document.getElementById('toast');
            const messageSpan = toast.querySelector('span');
            
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
            
            messageSpan.textContent = message;
            toast.className = `fixed top-4 right-4 text-white px-6 py-4 rounded-xl shadow-xl flex items-center space-x-3 transform transition-all duration-300 ease-in-out z-50 border-l-4 border-white ${bgClass}`;
            
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
            
            window.toastTimeout = setTimeout(() => {
                hideToast();
            }, 3000);
        };

        // Hide toast function
        window.hideToast = function() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-full', 'opacity-0');
            toast.classList.remove('translate-x-0', 'opacity-100');
            
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
        };

        // Function to update university dropdown options when education level changes
        function updateUniversityDropdowns(educationLevel) {
            const newOptions = universityOptions[educationLevel] || [];
            
            // Update university1 dropdown if it exists
            const uni1Select = document.querySelector('[data-field="university1"] select');
            if (uni1Select) {
                const currentValue = uni1Select.value;
                const optionsHtml = newOptions.map(opt => 
                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                uni1Select.innerHTML = `<option value="">Select University...</option>${optionsHtml}`;
            }
            
            // Update university2 dropdown if it exists
            const uni2Select = document.querySelector('[data-field="university2"] select');
            if (uni2Select) {
                const currentValue = uni2Select.value;
                const optionsHtml = newOptions.map(opt => 
                    `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                uni2Select.innerHTML = `<option value="">Select University...</option>${optionsHtml}`;
            }
        }

        // Inline Edit Functionality
        let currentEditingField = null;

        // Generate fullname from individual name components
        function generateFullName(firstName, lastName, middleName) {
            const parts = [];
            if (lastName && lastName.trim()) parts.push(lastName.trim());
            if (firstName && firstName.trim()) parts.push(firstName.trim());
            if (middleName && middleName.trim()) parts.push(middleName.trim());
            return parts.join(' ') || '';
        }

        // Start editing a field
        window.startEdit = function(event, fieldName) {
            event.stopPropagation(); // Prevent copy to clipboard
            
            // Cancel any existing edit
            if (currentEditingField && currentEditingField !== fieldName) {
                cancelEdit(currentEditingField);
            }
            
            currentEditingField = fieldName;
            
            const infoItem = document.querySelector(`[data-field="${fieldName}"]`).closest('.info-item');
            const infoValue = infoItem.querySelector('.info-value');
            const editForm = infoItem.querySelector('.edit-form');
            
            // Hide display value and show edit form
            infoValue.style.display = 'none';
            editForm.style.display = 'block';
            
            // Add editing class for visual feedback
            infoItem.classList.add('field-editing');
            
            // Focus on input
            const input = editForm.querySelector('.edit-input');
            input.focus();
            
            // Select text if it's a text input
            if (input.type === 'text' || input.type === 'email' || input.type === 'tel') {
                input.select();
            }
        };

        // Cancel editing a field
        window.cancelEdit = function(fieldName) {
            const infoItem = document.querySelector(`[data-field="${fieldName}"]`).closest('.info-item');
            const infoValue = infoItem.querySelector('.info-value');
            const editForm = infoItem.querySelector('.edit-form');
            
            // Show display value and hide edit form
            infoValue.style.display = 'flex';
            editForm.style.display = 'none';
            
            // Remove editing class
            infoItem.classList.remove('field-editing');
            
            // Reset input value to original
            const input = editForm.querySelector('.edit-input');
            const originalValue = window.currentStudentData[fieldName] || '';
            input.value = originalValue;
            
            currentEditingField = null;
        };

        // Save field changes
        window.saveField = async function(fieldName) {
            const infoItem = document.querySelector(`[data-field="${fieldName}"]`).closest('.info-item');
            const editForm = infoItem.querySelector('.edit-form');
            const input = editForm.querySelector('.edit-input');
            const saveBtn = editForm.querySelector('.save-btn');
            
            const newValue = input.value.trim();
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <div class="spinner" style="width: 12px; height: 12px;"></div>
                Saving...
            `;
            
            try {
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
                
                // Get current student ID from the modal
                const studentId = window.currentStudentData.id || 
                    allStudents.find(s => s.fullname === window.currentStudentData.fullname)?.id;
                
                if (!studentId) {
                    throw new Error('Student ID not found');
                }
                
                // Prepare update data
                const updateData = {
                    [fieldName]: newValue,
                    lastModified: new Date()
                };

                // If updating name components, also update fullname
                let newFullName = null;
                if (['firstName', 'lastName', 'middleName'].includes(fieldName)) {
                    const currentFirstName = fieldName === 'firstName' ? newValue : window.currentStudentData.firstName;
                    const currentLastName = fieldName === 'lastName' ? newValue : window.currentStudentData.lastName;
                    const currentMiddleName = fieldName === 'middleName' ? newValue : window.currentStudentData.middleName;
                    
                    newFullName = generateFullName(currentFirstName, currentLastName, currentMiddleName);
                    updateData.fullname = newFullName;
                }

                // If updating education level, clear university selections that don't match new level
                if (fieldName === 'educationLevel') {
                    const newUniversityOptions = universityOptions[newValue] || [];
                    
                    // Check if current universities are valid for new education level
                    if (window.currentStudentData.university1 && !newUniversityOptions.includes(window.currentStudentData.university1)) {
                        updateData.university1 = '';
                    }
                    if (window.currentStudentData.university2 && !newUniversityOptions.includes(window.currentStudentData.university2)) {
                        updateData.university2 = '';
                    }
                }
                
                // Store original data for audit logging
                const originalData = { ...window.currentStudentData };
                
                // Update in Firebase
                const studentRef = doc(db, "register", studentId);
                await updateDoc(studentRef, updateData);
                
                // Log the edit activity
                if (window.auditLogger) {
                    const changedFields = Object.keys(updateData).filter(key => key !== 'lastModified');
                    const newData = { ...originalData, ...updateData };
                    await window.auditLogger.logStudentEdit(
                        studentId, 
                        originalData.fullname || 'Unknown Student',
                        originalData,
                        newData,
                        changedFields
                    );
                    console.log('📝 Student edit activity logged for:', studentId, 'Field:', fieldName);
                }
                
                // Update local data
                window.currentStudentData[fieldName] = newValue;
                if (newFullName !== null) {
                    window.currentStudentData.fullname = newFullName;
                }
                
                const studentIndex = allStudents.findIndex(s => s.id === studentId);
                if (studentIndex !== -1) {
                    allStudents[studentIndex][fieldName] = newValue;
                    allStudents[studentIndex].lastModified = new Date();
                    if (newFullName !== null) {
                        allStudents[studentIndex].fullname = newFullName;
                    }
                }
                
                const filteredIndex = filteredStudents.findIndex(s => s.id === studentId);
                if (filteredIndex !== -1) {
                    filteredStudents[filteredIndex][fieldName] = newValue;
                    filteredStudents[filteredIndex].lastModified = new Date();
                    if (newFullName !== null) {
                        filteredStudents[filteredIndex].fullname = newFullName;
                    }
                }
                
                // Update display value
                const fieldValue = infoItem.querySelector('.field-value');
                fieldValue.textContent = newValue || 'N/A';
                
                // Update fullname display if name components were changed
                if (newFullName !== null) {
                    const fullNameField = document.querySelector('[data-field="fullname"] .field-value');
                    if (fullNameField) {
                        fullNameField.textContent = newFullName || 'N/A';
                    }
                    
                    // Update modal header
                    document.getElementById('modalStudentName').textContent = newFullName || 'Unknown Student';
                    const avatar = document.getElementById('studentAvatar');
                    const initials = newFullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    avatar.textContent = initials;
                }

                // Update university dropdowns if education level changed
                if (fieldName === 'educationLevel') {
                    // Update university field displays if they were cleared
                    if (updateData.university1 === '') {
                        const uni1Field = document.querySelector('[data-field="university1"] .field-value');
                        if (uni1Field) uni1Field.textContent = 'N/A';
                        window.currentStudentData.university1 = '';
                    }
                    if (updateData.university2 === '') {
                        const uni2Field = document.querySelector('[data-field="university2"] .field-value');
                        if (uni2Field) uni2Field.textContent = 'N/A';
                        window.currentStudentData.university2 = '';
                    }
                    
                    // Update university dropdown options for future edits
                    updateUniversityDropdowns(newValue);
                }
                
                // Refresh table to show changes
                updateTable();
                
                // Show success and exit edit mode
                showToast(`✅ ${fieldName} updated successfully`, 'bg-green-600');
                
                // Exit edit mode
                const infoValue = infoItem.querySelector('.info-value');
                infoValue.style.display = 'flex';
                editForm.style.display = 'none';
                infoItem.classList.remove('field-editing');
                currentEditingField = null;
                
                console.log(`✅ Field ${fieldName} updated successfully`);
                
            } catch (error) {
                console.error(`❌ Error updating field ${fieldName}:`, error);
                showToast(`❌ Error updating ${fieldName}: ${error.message}`, 'bg-red-600');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Save
                `;
            }
        };

        // Keyboard shortcuts for inline editing
        document.addEventListener('DOMContentLoaded', () => {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Escape key to close modals or cancel editing
                if (e.key === 'Escape') {
                    if (currentEditingField) {
                        cancelEdit(currentEditingField);
                    } else if (document.getElementById('studentModal').classList.contains('active')) {
                        closeStudentModal();
                    }
                }
                
                // Enter key to save when editing a field (except textarea)
                if (e.key === 'Enter' && currentEditingField) {
                    const editForm = document.querySelector(`[data-field="${currentEditingField}"]`).closest('.info-item').querySelector('.edit-form');
                    const input = editForm.querySelector('.edit-input');
                    
                    // Don't save on Enter for textarea (allow line breaks)
                    if (input.tagName.toLowerCase() !== 'textarea') {
                        e.preventDefault();
                        saveField(currentEditingField);
                    }
                }
                
                // Ctrl+S to save when editing a field
                if (e.ctrlKey && e.key === 's' && currentEditingField) {
                    e.preventDefault();
                    saveField(currentEditingField);
                }
            });
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Student List Application Starting...');
            setupPagination();
        setTimeout(() => {
            loadDataDirectly();
        }, 1000);
        });

        console.log('🚀 Student List Application Ready');
    </script>
</body>
</html>